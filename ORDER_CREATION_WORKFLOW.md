# فرآیند ایجاد سفارش (Order Creation Workflow)

## خلاصه کلی
سفارش از طریق 3 مرحله انجام می‌شود:

```
سبد خرید → انتخاب آدرس و روش ارسال → پرداخت آنلاین → تأیید سفارش
```

---

## مرحله اول: دریافت سبد خرید (Cart Review)

### API: دریافت سبد خرید کاربر
```
GET /cart/user/:userId
```

**درخواست:** 
- Header: `Authorization: Bearer {token}`

**پاسخ:**
```json
{
  "id": 1,
  "user": { id: 1, name: "علی" },
  "items": [
    {
      "id": 1,
      "product": { "id": 1, "name": "محصول 1" },
      "offer": { "id": 1, "price": 100000 },
      "quantity": 2
    }
  ],
  "totalPrice": 200000
}
```

**نمایش:**
- لیست محصولات در سبد
- قیمت کل
- دکمه "ادامه به مرحله بعد"

---

## مرحله دوم: انتخاب آدرس ارسال و روش پرداخت

### مرحله 2.1: دریافت آدرس‌های کاربر

#### API: دریافت تمام آدرس‌های کاربر
```
GET /user-profile/addresses
```

**درخواست:**
- Header: `Authorization: Bearer {token}`

**پاسخ:**
```json
[
  {
    "id": 1,
    "title": "خانه",
    "recipientName": "علی احمدی",
    "phone": "09123456789",
    "address": "تهران، خیابان ولیعصر، پلاک 123",
    "city": "تهران",
    "province": "تهران",
    "postalCode": "1234567890"
  },
  {
    "id": 2,
    "title": "محل کار",
    "recipientName": "علی احمدی",
    "phone": "09998765432",
    "address": "تهران، خیابان کریمخان، پلاک 456",
    "city": "تهران",
    "province": "تهران",
    "postalCode": "0987654321"
  }
]
```

**نمایش:**
- لیست آدرس‌های کاربر با عنوان و نام
- دکمه برای انتخاب هر آدرس
- دکمه برای اضافه کردن آدرس جدید (اختیاری)

---

### مرحله 2.2: انتخاب روش ارسال

**روش‌های ارسال (Shipping Methods):**
```
- پیک موتوری (Express): 50,000 تومان
- پست عادی (Standard): 20,000 تومان  
- پست ویژه (Premium): 100,000 تومان
```

**نمایش:**
- رادیو بتن‌های انتخاب روش ارسال
- نمایش هزینه هر روش
- محاسبه خودکار تخفیف (اگر وجود دارد)
- محاسبه خودکار مالیات و قیمت نهایی

**محاسبات:**
```
قیمت نهایی = (جمع محصولات) + (هزینه ارسال) - (تخفیف) + (مالیات)
```

---

## مرحله سوم: پرداخت آنلاین

### مرحله 3.1: ایجاد سفارش

#### API: ایجاد سفارش جدید
```
POST /orders
```

**درخواست:**
```json
{
  "userId": 1,
  "shippingAddress": "تهران، خیابان ولیعصر، پلاک 123",
  "shippingPhone": "09123456789",
  "recipientName": "علی احمدی",
  "paymentMethod": "online",
  "customerNote": "لطفاً قبل از ارسال تماس بگیرید"
}
```

**پاسخ (HTTP 201):**
```json
{
  "id": 1,
  "orderNumber": "ORD-20250212-0001",
  "user": { "id": 1, "name": "علی" },
  "items": [
    {
      "id": 1,
      "product": { "id": 1, "name": "محصول 1" },
      "quantity": 2,
      "price": 100000
    }
  ],
  "subtotal": 200000,
  "shippingCost": 50000,
  "discount": 0,
  "tax": 0,
  "total": 250000,
  "status": "pending",
  "paymentMethod": "online",
  "paymentStatus": "pending",
  "shippingAddress": "تهران، خیابان ولیعصر، پلاک 123",
  "createdAt": "2025-02-12T10:30:00Z"
}
```

**وضعیت سفارش:**
- `PENDING`: در انتظار پرداخت
- `PAID`: پرداخت شده
- `PROCESSING`: در حال پردازش
- `SHIPPED`: ارسال شده
- `DELIVERED`: تحویل داده شده
- `CANCELLED`: لغو شده

---

### مرحله 3.2: شروع فرآیند پرداخت

#### API: درخواست درگاه پرداخت (Gateway Request)
```
POST /payments/initiate
```

**درخواست:**
```json
{
  "orderId": 1
}
```

**پاسخ (HTTP 200):**
```json
{
  "orderId": 1,
  "orderNumber": "ORD-20250212-0001",
  "total": 250000,
  "currency": "IRR",
  "paymentUrl": "https://payment-gateway.com/pay?authority=mock-1234567890&orderId=1",
  "message": "درخواست پرداخت ایجاد شد. به درگاه پرداخت هدایت شوید"
}
```

**نمایش:**
- نمایش اطلاعات سفارش
- دکمه "پرداخت" که کاربر را به درگاه پرداخت هدایت می‌کند

---

### مرحله 3.3: تأیید پرداخت (بعد از بازگشت از درگاه)

#### API: تأیید تراکنش پرداخت
```
PATCH /orders/:orderId/confirm-payment
```

**درخواست:**
```json
{
  "transactionId": "authority-code-from-payment-gateway"
}
```

**پاسخ (HTTP 200):**
```json
{
  "id": 1,
  "orderNumber": "ORD-20250212-0001",
  "status": "paid",
  "paymentStatus": "completed",
  "paymentMethod": "online",
  "paidAt": "2025-02-12T10:35:00Z",
  "transactionId": "authority-code-from-payment-gateway",
  "total": 250000,
  "message": "پرداخت با موفقیت تأیید شد"
}
```

---

## جریان کامل (Complete Flow)

```
┌─────────────────────────────────────┐
│ صفحه سبد خرید                        │
│ - نمایش محصولات                      │
│ - قیمت کل                           │
└────────────┬────────────────────────┘
             │ GET /cart/user/:userId
             ↓
┌─────────────────────────────────────┐
│ صفحه انتخاب آدرس و روش پرداخت       │
│ - دریافت آدرس‌ها                     │
│ - انتخاب روش ارسال                   │
│ - مشاهده قیمت نهایی                  │
└────────────┬────────────────────────┘
             │ GET /user-profile/addresses
             │ (select address & shipping method)
             │ POST /orders
             ↓
┌─────────────────────────────────────┐
│ صفحه پرداخت                         │
│ - نمایش اطلاعات سفارش                │
│ - دکمه پرداخت                        │
└────────────┬────────────────────────┘
             │ POST /payments/initiate
             │ (redirect to payment gateway)
             ↓
┌─────────────────────────────────────┐
│ درگاه پرداخت (بیرونی)               │
│ - درخواست کارت اعتباری               │
└────────────┬────────────────────────┘
             │ (user enters card info)
             ↓
┌─────────────────────────────────────┐
│ بازگشت به برنامه                    │
│ - PATCH /orders/:id/confirm-payment │
└────────────┬────────────────────────┘
             │
             ↓
┌─────────────────────────────────────┐
│ صفحه تأیید موفقیت سفارش            │
│ - شماره سفارش                       │
│ - همه جزئیات                        │
└─────────────────────────────────────┘
```

---

## خطاهای ممکن و رسیدگی

| خطا | کد | رسیدگی |
|-----|-----|---------|
| سبد خرید خالی | 400 | پیام: "سبد خرید خالی است" |
| موجودی کافی نیست | 400 | پیام: "موجودی محصول کافی نیست" |
| کاربر یافت نشد | 404 | پیام: "کاربر یافت نشد" |
| آدرس نامعتبر | 400 | پیام: "آدرس انتخاب شده نامعتبر است" |
| روش پرداخت نامعتبر | 400 | پیام: "روش پرداخت نامعتبر است" |
| شکست پرداخت | 400 | پیام: "پرداخت ناموفق بود. دوباره تلاش کنید" |

---

## یادداشت‌های مهم

1. **معرفی سازی (Transactions):**
   - در هنگام ایجاد سفارش، موجودی محصولات قفل می‌شود
   - اگر پرداخت ناموفق باشد، موجودی آزاد می‌شود

2. **شماره سفارش (Order Number):**
   - قالب: `ORD-YYYYMMDD-0001`
   - مثال: `ORD-20250212-0001`

3. **روش‌های پرداخت (Payment Methods):**
   - `online`: پرداخت آنلاین
   - `cash_on_delivery`: پرداخت در محل
   - `wallet`: کیف پول

4. **سبد خرید خودکار:**
   - هنگام ایجاد سفارش، سبد خرید خالی می‌شود

5. **احراز هویت (Authentication):**
   - تمام درخواست‌ها نیاز به `Authorization: Bearer {JWT_TOKEN}` دارند
   - کاربر فقط می‌تواند سفارش خود را ایجاد کند

---

## متغیرهای محیطی مورد نیاز

```
PAYMENT_GATEWAY_URL=https://payment-gateway-api.com
PAYMENT_MERCHANT_ID=your-merchant-id
CALLBACK_URL=https://your-app.com/payment-callback
```

---

## نکات توسعه (Development Notes)

- [ ] تست تمام endpoint‌های Order API
- [ ] پیش‌نمایش قیمت نهایی قبل از ایجاد سفارش
- [ ] مدیریت موجودی محصولات
- [ ] اطلاع‌رسانی ایمیل پس از سفارش
- [ ] تاریخچه سفارش برای کاربر
