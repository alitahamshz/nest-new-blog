# ุฎูุงุตู ุชุบุฑุงุช - ุณุณุชู ูุฏุฑุช ุขุฏุฑุณ ูุณุชูู

## ููุฏูู
ุงฺฉููู ฺฉุงุฑุจุฑุงู ูโุชูุงููุฏ ุขุฏุฑุณโูุง ุฎูุฏ ุฑุง ุขูพุฏุช ู ูุฏุฑุช ฺฉููุฏุ **ุญุช ุงฺฏุฑ ูพุฑููุงู ฺฉุงูู ูุฏุงุดุชู ุจุงุดูุฏ**. ุณุณุชู ุฎูุฏฺฉุงุฑ ฺฉ ูพุฑููุงู ฺฉุงุฑุจุฑ ุงุฌุงุฏ ูโฺฉูุฏ ุฏุฑ ุตูุฑุช ูุงุฒ.

---

## ุชุบุฑุงุช ุงูุฌุงู ุดุฏู

### 1. **ุชุบุฑ ูุนูุงุฑ ุฏุชุงุจุณ** ๐
**ูุงู: `src/entities/address.entity.ts`**
- ุงุถุงูู ุดุฏู ุฑุงุจุทู ูุณุชูู `@ManyToOne(() => User)` ุจู ุขุฏุฑุณ
- ุญูุธ ุฑุงุจุทู ูุฏู ุจุง `UserProfile` (ููุงุงู ุจุฑุง ุณุงุฒฺฏุงุฑ)
- ุชุบุฑ `userProfile` ุจู `nullable: true` ุจุง `onDelete: 'SET NULL'`

**ูุงู: `src/entities/user.entity.ts`**
- ุงุถุงูู ุดุฏู import `Address`
- ุงุถุงูู ุดุฏู ุฑุงุจุทู `@OneToMany(() => Address)` ุจุฑุง ุฏุณุชุฑุณ ูุณุชูู ฺฉุงุฑุจุฑ ุจู ุขุฏุฑุณโูุง

### 2. **ุจูุจูุฏ Serivce** ๐ง
**ูุงู: `src/users/user-profile.service.ts`**

#### ุชุบุฑุงุช ฺฉูุฏ:
- ุงูุฒูุฏู `User` repository ุจู ุณุงุฒูุฏู
- **Refactor ฺฉู ุฑูุดโูุง ุขุฏุฑุณ** ุจุฑุง ฺฉุงุฑ ุจุฏูู ูพุฑููุงู:
  
  - `getAddresses()` - ุงฺฉููู ูุณุชููุงู ุงุฒ ุฌุฏูู addresses ฺฉุงุฑุจุฑ ุฏุฑุงูุช ูโฺฉูุฏ
  - `addAddress()` - ุณุงุฒ ุฎูุฏฺฉุงุฑ ูพุฑููุงู ุงฺฏุฑ ูุฌูุฏ ูุฏุงุดุชู ุจุงุดุฏ โจ
  - `updateAddress()` - ฺฉุงุฑ ุจุฏูู ูุงุฒ ุจู ูพุฑููุงู
  - `removeAddress()` - ุญุฐู ุงูู ุขุฏุฑุณ
  - `setDefaultAddress()` - ุชูุธู ุขุฏุฑุณ ูพุดโูุฑุถ

#### ูฺฺฏ ุฌุฏุฏ:
```typescript
// ุงฺฏุฑ ูพุฑููุงู ูุฌูุฏ ูุฏุงุดุชุ ุฎูุฏฺฉุงุฑ ุงุฌุงุฏ ูโุดูุฏ
let profile = await this.profileRepo.findOne({...});
if (!profile) {
  profile = this.profileRepo.create({ user: { id: userId } });
  await this.profileRepo.save(profile);
}
```

### 3. **ุจุฑูุฒุฑุณุงู Module** ๐ฆ
**ูุงู: `src/users/user-profile.module.ts`**
- ุงุถุงูู ุดุฏู `User` repository ุจู imports

### 4. **Migration Database** ๐๏ธ
**ูุงู: `src/migrations/1739017200000-AddUserIdToAddresses.ts`**

#### ุนููุงุช:
1. ุงุถุงูู ฺฉุฑุฏู ุณุชูู `userId` ุจู ุฌุฏูู `addresses`
2. ููุฏุงุฑ ุฏู ุฎูุฏฺฉุงุฑ `userId` ุจุฑุง ุฑฺฉูุฑุฏูุง ูุฏู
3. ุงุฌุงุฏ Foreign Key ุจุฑุง `userId` โ `users.id` (CASCADE)
4. ุชุบุฑ `userProfileId` ุจู nullable

---

## ุฑููุฏูุง API ููุฌูุฏ ๐

### Endpoints ุจุฏูู ุชุบุฑ (ุงูุง ุฎูุฏุดุงู ุจูุชุฑ ุดุฏูโุงูุฏ):

```bash
# ุฏุฑุงูุช ุชูุงู ุขุฏุฑุณโูุง
GET /profile/addresses

# ุฏุฑุงูุช ุขุฏุฑุณ ูพุดโูุฑุถ
GET /profile/addresses/default

# ุงูุฒูุฏู ุขุฏุฑุณ ุฌุฏุฏ (ุจุฏูู ูุงุฒ ุจู ูพุฑููุงู ฺฉุงูู!)
POST /profile/addresses
{
  "title": "ุฎุงูู",
  "recipientName": "ุนู ุงุญูุฏ",
  "phone": "09123456789",
  "address": "ุชูุฑุงูุ ุฎุงุจุงู...",
  "city": "ุชูุฑุงู",
  "province": "ุชูุฑุงู",
  "postalCode": "1234567890",
  "isDefault": false
}

# ุจุฑูุฒุฑุณุงู ุขุฏุฑุณ
PATCH /profile/addresses/:id

# ุญุฐู ุขุฏุฑุณ
DELETE /profile/addresses/:id

# ุชูุธู ุขุฏุฑุณ ูพุดโูุฑุถ
PATCH /profile/addresses/:id/set-default
```

---

## ูุซุงู ุนูู ๐ก

### ุณูุงุฑู: ฺฉุงุฑุจุฑ ุฌุฏุฏ ุจุฏูู ูพุฑููุงู
```typescript
// 1๏ธโฃ ฺฉุงุฑุจุฑ ุซุจุชโูุงู ูโฺฉูุฏ โ userId: 5
// 2๏ธโฃ ุณุฑุงู ุขุฏุฑุณ ุฎูุฏ ุฑุง ุงุถุงูู ูโฺฉูุฏ
POST /profile/addresses {
  "title": "ุฎุงูู ุฌุฏุฏ",
  "recipientName": "ูุญูุฏ",
  "phone": "09988776655",
  "address": "ูุดูุฏุ ุฎุงุจุงู ุขุฒุงุฏ",
  "city": "ูุดูุฏ",
  "province": "ุฎุฑุงุณุงู ุฑุถู",
  "postalCode": "9175698765",
  "isDefault": true
}

// โ ูุชุฌู:
// - ุขุฏุฑุณ ุงุฌุงุฏ ุดุฏู ุฏุฑ ุฌุฏูู addresses
// - ูพุฑููุงู ุฎูุฏฺฉุงุฑ ุงุฌุงุฏ ุดุฏู
// - userProfileId = null (ุง profile ID ุงฺฏุฑ ูุฌูุฏ ุฏุงุดุช)
// - userId = 5 (ูุทุงุจูุช ูุณุชูู)
```

---

## ูุฒุงุง โจ

| ูฺฺฏ | ูุจู | ุจุนุฏ |
|------|-----|-----|
| ูุงุฒ ูพุฑููุงู ฺฉุงูู | โ ุงูุฒุงู | โ ุงุฎุชุงุฑ |
| ูุฏุฑุช ุขุฏุฑุณ | ูพฺุฏู | ุณุงุฏู |
| ุฎุทุงูุง ูุฑุฏูุฏ | ุจุณุงุฑ | ฺฉู |
| ุณุฑุนุช ุงุฌุงุฏ ุขุฏุฑุณ | ุขูุณุชู | ุจุณุงุฑ ุณุฑุน |

---

## ูฺฉุงุช ูู โ๏ธ

1. **ุฏุงุฏูโูุง ูุฏู**: Migration ุฎูุฏฺฉุงุฑ `userId` ุฑุง ุจุฑุง ุฑฺฉูุฑุฏูุง ูุฏู ูพุฑ ูโฺฉูุฏ
2. **ุณุงุฒฺฏุงุฑ ุนูุจโฺฏุฑุฏ**: ุฑุงุจุทู `UserProfile` ุญูุธ ุดุฏู ุงุณุช
3. **Cascade**: ุญุฐู ฺฉุงุฑุจุฑุ ุชูุงู ุขุฏุฑุณโูุง ุงู ุฑุง ุญุฐู ูโฺฉูุฏ
4. **NULL Safety**: `userProfileId` ูโุชูุงูุฏ NULL ุจุงุดุฏ

---

## ูุงูโูุง ุชุบุฑ ุงูุชู ๐

```
src/entities/
  โโโ address.entity.ts (ุงุตูุงุญ)
  โโโ user.entity.ts (ุงุตูุงุญ)

src/users/
  โโโ user-profile.service.ts (ุงุตูุงุญ)
  โโโ user-profile.module.ts (ุงุตูุงุญ)

src/migrations/
  โโโ 1739017200000-AddUserIdToAddresses.ts (ุฌุฏุฏ)
```

---

## ุงุฌุฑุง Migration ๐

```bash
npm run typeorm migration:run
```

